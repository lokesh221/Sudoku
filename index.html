<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Sudoku Pro</title>
    
    <style>
        :root {
            --bg: #121212; --cell-bg: #1e1e1e; --text: #e0e0e0;
            --border: #333; --thick: #888;
            --highlight: #2c2c2c; --match: #3d3d3d; --error: #cf6679;
            --accent: #bb86fc; --fixed-text: var(--accent);
        }
        body.light-mode {
            --bg: #ffffff; --cell-bg: #f8f9fa; --text: #1a1a1a;
            --border: #dee2e6; --thick: #495057;
            --highlight: #f1f3f5; --match: #e2e6ea; --error: #d00000;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 10px; height: 100vh; overflow: hidden;
        }
        #timer { font-family: monospace; font-size: 1.3rem; margin-bottom: 5px; color: var(--accent); font-weight: bold; }
        
        #grid { 
            display: grid; grid-template-columns: repeat(9, 1fr); 
            width: 94vw; height: 94vw; max-width: 420px; max-height: 420px;
            background: var(--thick); border: 2.5px solid var(--thick); border-radius: 4px;
        }

        .cell {
            background: var(--cell-bg); display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; border: 0.5px solid var(--border); box-sizing: border-box;
            color: var(--text); transition: background 0.1s;
        }
        .cell:nth-child(3n) { border-right: 3px solid var(--thick); }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 3px solid var(--thick); }

        .cell.related { background: var(--highlight); }
        .cell.same-num { background: var(--match); outline: 2px inset rgba(255,255,255,0.05); }
        .cell.selected { background: var(--accent) !important; color: #ffffff !important; }
        
        .cell.fixed { font-weight: 900; color: var(--fixed-text); }
        body:not(.hard-mode-active) .cell.conflict { color: var(--error) !important; font-weight: bold; text-decoration: underline; }

        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 94vw; max-width: 420px; margin-top: 10px; }
        .numpad button { padding: 12px 0; border: none; border-radius: 8px; background: #2a2a2a; color: white; font-weight: bold; font-size: 1.3rem; }
        .numpad button.done { opacity: 0.1; pointer-events: none; }
        body.light-mode .numpad button { background: #eee; color: #222; border: 1px solid #ccc; }
        
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 94vw; max-width: 420px; margin-top: 10px; }
        .controls button, select { padding: 10px 2px; border: none; border-radius: 6px; background: var(--accent); color: white !important; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; }
        
        select { background: #333 !important; color: white !important; text-align-last: center; }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px);
        }
        .victory-card { background: var(--cell-bg); padding: 40px; border-radius: 24px; text-align: center; border: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div id="timer">00:00</div>
    <div id="grid"></div>

    <div class="numpad">
        <button onclick="handleInput(1)" id="num-1">1</button><button onclick="handleInput(2)" id="num-2">2</button><button onclick="handleInput(3)" id="num-3">3</button>
        <button onclick="handleInput(4)" id="num-4">4</button><button onclick="handleInput(5)" id="num-5">5</button><button onclick="handleInput(6)" id="num-6">6</button>
        <button onclick="handleInput(7)" id="num-7">7</button><button onclick="handleInput(8)" id="num-8">8</button><button onclick="handleInput(9)" id="num-9">9</button>
        <button style="background:var(--error); color:white !important;" onclick="handleInput(null)">⌫</button>
    </div>

    <div class="controls">
        <select id="difficulty" onchange="initGame()"><option value="30">Easy</option><option value="45">Med</option><option value="60">Hard</option></select>
        <button onclick="undoMove()">Undo</button>
        <button onclick="initGame()" style="background:#e67e22 !important;">New Game</button>
        <button onclick="getHint()" style="background:#009688 !important;">Hint</button>
        <button onclick="toggleHardMode()" id="hard-btn">Hard Off</button>
        <button onclick="toggleTheme()">Theme</button>
        <button onclick="changeColor()">Color</button>
        <button onclick="toggleNotes()" id="notes-btn" style="grid-column: span 2;">Notes Off</button>
    </div>

    <div id="overlay">
        <div class="victory-card">
            <h1 style="color:var(--accent); margin-top:0;">VICTORY!</h1>
            <div id="star-container" style="font-size:2.5rem; margin:10px 0;">⭐⭐⭐</div>
            <p id="final-time" style="font-size:1.2rem;">Time: 00:00</p>
            <button onclick="initGame()" style="padding:12px 24px; background:var(--accent); border:none; border-radius:8px; font-weight:bold; width:100%; color: white;">Play Again</button>
        </div>
    </div>

    <script>
        "use strict";
        const gridDiv = document.getElementById('grid'), timerDiv = document.getElementById('timer'), overlay = document.getElementById('overlay');
        let solution = [], seconds = 0, timerInterval, isNotesMode = false, isHardMode = false, selectedCell = null, history = [];
        
        const palettes = [
            ['#bb86fc', '#6200ee'], ['#03dac6', '#00796b'], 
            ['#ffb74d', '#d35400'], ['#4fc3f7', '#0984e3'], ['#ff8a65', '#c0392b']
        ];
        let paletteIndex = 0;

        function updateColors() {
            const isLight = document.body.classList.contains('light-mode');
            const chosenColor = isLight ? palettes[paletteIndex][1] : palettes[paletteIndex][0];
            document.documentElement.style.setProperty('--accent', chosenColor);
            document.documentElement.style.setProperty('--fixed-text', chosenColor);
        }

        window.toggleTheme = () => { document.body.classList.toggle('light-mode'); updateColors(); };
        window.changeColor = () => { paletteIndex = (paletteIndex + 1) % palettes.length; updateColors(); };
        
        window.toggleHardMode = () => {
            isHardMode = !isHardMode;
            document.body.classList.toggle('hard-mode-active', isHardMode);
            const btn = document.getElementById('hard-btn');
            btn.textContent = isHardMode ? "Hard On" : "Hard Off";
            btn.style.background = isHardMode ? "#e91e63" : "var(--accent)";
        };

        function startTimer() {
            clearInterval(timerInterval); seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timerDiv.textContent = `${Math.floor(seconds/60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`;
            }, 1000);
        }

        window.toggleNotes = () => { 
            isNotesMode = !isNotesMode; 
            const btn = document.getElementById('notes-btn');
            btn.textContent = isNotesMode ? "Notes On" : "Notes Off";
        };

        function isValid(b, r, c, k) {
            for (let i = 0; i < 9; i++) {
                const m = 3 * Math.floor(r/3) + Math.floor(i/3), n = 3 * Math.floor(c/3) + i % 3;
                if (b[r][i] == k || b[i][c] == k || b[m][n] == k) return false;
            } return true;
        }

        function solve(b) {
            for (let r = 0; r < 9; r++) { for (let c = 0; c < 9; c++) {
                if (b[r][c] === 0) { for (let k = 1; k <= 9; k++) {
                    if (isValid(b, r, c, k)) { b[r][c] = k; if (solve(b)) return true; b[r][c] = 0; }
                } return false; }
            } } return true;
        }

        window.initGame = () => {
            history = []; overlay.style.display = 'none'; gridDiv.style.filter = 'none'; startTimer();
            let board = Array.from({length: 9}, () => Array(9).fill(0));
            for (let i = 0; i < 9; i += 3) { for (let r = 0; r < 3; r++) { for (let c = 0; c < 3; c++) {
                let num; do { num = Math.floor(Math.random() * 9) + 1; } while (!isValid(board, i+r, i+c, num));
                board[i+r][i+c] = num;
            } } }
            solve(board); solution = board.map(row => [...row]);
            const diff = document.getElementById('difficulty').value;
            const puzzle = board.map(row => row.map(v => Math.random() * 81 < (81 - diff) ? v : 0));
            render(puzzle); updateNumpadStatus(); updateColors();
        };

        function render(p) {
            gridDiv.textContent = '';
            for (let r = 0; r < 9; r++) { for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell'; cell.dataset.r = r; cell.dataset.c = c;
                if (p[r][c] !== 0) { cell.textContent = p[r][c]; cell.classList.add('fixed'); }
                cell.onclick = () => { selectedCell = cell; highlight(cell); };
                gridDiv.appendChild(cell);
            } }
        }

        function highlight(cell) {
            const r = cell.dataset.r, c = cell.dataset.c, val = cell.textContent;
            document.querySelectorAll('.cell').forEach(el => {
                el.classList.remove('related', 'same-num', 'selected');
                if (el.dataset.r == r || el.dataset.c == c) el.classList.add('related');
                if (val && el.textContent === val && val !== "" && !val.includes('n')) el.classList.add('same-num');
            });
            cell.classList.add('selected');
        }

        window.handleInput = (num, isUndo = false) => {
            if (!selectedCell || selectedCell.classList.contains('fixed')) return;
            if (!isUndo) history.push({ r: selectedCell.dataset.r, c: selectedCell.dataset.c, v: selectedCell.dataset.val || '', t: selectedCell.textContent, s: selectedCell.style.fontSize });

            if (num === null) { selectedCell.textContent = ''; delete selectedCell.dataset.val; selectedCell.classList.remove('conflict'); }
            else if (isNotesMode) { selectedCell.textContent = `n${num}`; selectedCell.style.fontSize = "0.75rem"; selectedCell.classList.remove('conflict'); }
            else { 
                selectedCell.textContent = num; selectedCell.dataset.val = num; selectedCell.style.fontSize = "1.5rem"; 
                if (parseInt(num) !== solution[selectedCell.dataset.r][selectedCell.dataset.c]) selectedCell.classList.add('conflict');
                else selectedCell.classList.remove('conflict');
            }
            highlight(selectedCell); updateNumpadStatus(); checkAutoValidate();
        };

        window.undoMove = () => {
            if (history.length === 0) return;
            const m = history.pop();
            selectedCell = document.querySelector(`.cell[data-r="${m.r}"][data-c="${m.c}"]`);
            selectedCell.textContent = m.t; selectedCell.dataset.val = m.v; selectedCell.style.fontSize = m.s;
            if (m.v && parseInt(m.v) !== solution[m.r][m.c]) selectedCell.classList.add('conflict');
            else selectedCell.classList.remove('conflict');
            highlight(selectedCell); updateNumpadStatus();
        };

        window.getHint = () => {
            const empties = Array.from(document.querySelectorAll('.cell')).filter(c => !c.classList.contains('fixed') && (c.textContent === '' || c.textContent.includes('n')));
            if (empties.length === 0) return;
            const target = empties[Math.floor(Math.random() * empties.length)];
            selectedCell = target; seconds += 30;
            handleInput(solution[target.dataset.r][target.dataset.c]);
        };

        function updateNumpadStatus() {
            const counts = {};
            document.querySelectorAll('.cell').forEach(c => {
                const v = parseInt(c.dataset.val || c.textContent);
                if (v && !c.textContent.includes('n') && v === solution[c.dataset.r][c.dataset.c]) counts[v] = (counts[v] || 0) + 1;
            });
            for (let i = 1; i <= 9; i++) document.getElementById(`num-${i}`).classList.toggle('done', counts[i] === 9);
        }

        function checkAutoValidate() {
            const cells = Array.from(document.querySelectorAll('.cell'));
            const filledCount = cells.filter(c => c.textContent !== '' && !c.textContent.includes('n')).length;
            if (filledCount === 81) {
                if (cells.every(c => (c.dataset.val || c.textContent) == solution[c.dataset.r][c.dataset.c])) {
                    clearInterval(timerInterval);
                    document.getElementById('star-container').textContent = seconds < 300 ? "⭐⭐⭐" : (seconds < 600 ? "⭐⭐" : "⭐");
                    document.getElementById('final-time').textContent = `Time: ${timerDiv.textContent}`;
                    overlay.style.display = 'flex'; gridDiv.style.filter = 'blur(10px)';
                }
            }
        }
        window.onload = initGame;
    </script>
</body>
</html>
