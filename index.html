<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
    <title>Sudoku Pro Cloud</title>
    <style>
        :root {
            --bg: #121212; --cell-bg: #1e1e1e; --text: #e0e0e0;
            --accent: #bb86fc; --border: #333; --thick: #888;
            --highlight: #2c2c2c; --match: #3d3d3d;
        }
        body.light-mode {
            --bg: #f5f5f5; --cell-bg: #ffffff; --text: #222;
            --accent: #6200ee; --border: #e0e0e0; --thick: #999;
            --highlight: #f0e6ff; --match: #d1c4e9;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif;
            transition: background 0.3s; display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 10px; box-sizing: border-box; overflow: hidden; height: 100vh;
        }
        #timer { font-family: monospace; font-size: 1.2rem; margin-bottom: 8px; color: var(--accent); font-weight: bold; }
        
        #grid { 
            display: grid; grid-template-columns: repeat(9, 1fr); 
            width: 92vw; height: 92vw; max-width: 420px; max-height: 420px;
            background: var(--thick); border: 2px solid var(--thick);
            border-radius: 4px; transition: filter 0.5s ease;
        }

        .cell {
            background: var(--cell-bg); display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; border: 0.5px solid var(--border); box-sizing: border-box;
        }
        .cell:nth-child(3n) { border-right: 3px solid var(--thick); }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 3px solid var(--thick); }

        .cell.related { background: var(--highlight); }
        .cell.same-num { background: var(--match); color: var(--accent); }
        .cell.selected { background: var(--accent) !important; color: #000 !important; }
        .cell.fixed { font-weight: 800; }

        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 92vw; max-width: 420px; margin-top: 15px; }
        .numpad button { padding: 14px 0; border: none; border-radius: 8px; background: #2a2a2a; color: white; font-weight: bold; font-size: 1.2rem; transition: opacity 0.3s; }
        .numpad button.done { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        body.light-mode .numpad button { background: #fff; border: 1px solid #ddd; color: #222; }
        
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 92vw; max-width: 420px; margin-top: 15px; }
        .controls button, select { padding: 12px 4px; border: none; border-radius: 8px; background: var(--accent); color: white; font-weight: bold; font-size: 0.8rem; }
        body:not(.light-mode) .controls button { color: black; }
        select { background: #333 !important; color: white !important; }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            animation: fadeIn 0.5s; backdrop-filter: blur(5px);
        }
        .victory-card { background: var(--cell-bg); padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--accent); }
        .stars { font-size: 2.5rem; color: #ffd700; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="timer">00:00</div>
    <div id="grid"></div>

    <div class="numpad" id="numpad">
        <button onclick="handleInput(1)" id="num-1">1</button><button onclick="handleInput(2)" id="num-2">2</button><button onclick="handleInput(3)" id="num-3">3</button>
        <button onclick="handleInput(4)" id="num-4">4</button><button onclick="handleInput(5)" id="num-5">5</button><button onclick="handleInput(6)" id="num-6">6</button>
        <button onclick="handleInput(7)" id="num-7">7</button><button onclick="handleInput(8)" id="num-8">8</button><button onclick="handleInput(9)" id="num-9">9</button>
        <button style="background:#cf6679; color:white;" onclick="handleInput(null)">⌫</button>
    </div>

    <div class="controls">
        <select id="difficulty" onchange="initGame()">
            <option value="30">Easy</option><option value="45">Medium</option><option value="60">Hard</option>
        </select>
        <button onclick="undoMove()">Undo</button>
        <button onclick="initGame()">New Game</button>
        <button onclick="toggleTheme()">Theme</button>
        <button onclick="toggleNotes()" id="notes-btn">Notes</button>
        <button onclick="changeColor()">Color</button>
    </div>

    <div id="overlay">
        <div class="victory-card">
            <h1>VICTORY!</h1>
            <div id="star-container" class="stars">⭐⭐⭐</div>
            <p id="final-time">Time: 00:00</p>
            <button onclick="initGame()" style="padding:10px 20px; background:var(--accent); border:none; border-radius:8px; font-weight:bold;">New Game</button>
        </div>
    </div>

    <script>
        "use strict";

        const gridDiv = document.getElementById('grid');
        const timerDiv = document.getElementById('timer');
        const overlay = document.getElementById('overlay');
        let solution = [], seconds = 0, timerInterval, isNotesMode = false, selectedCell = null;
        let history = []; // Undo stack
        let colors = ['#bb86fc', '#03dac6', '#ffb74d', '#4fc3f7'];
        let colorIndex = 0;

        function startTimer() {
            clearInterval(timerInterval);
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                let m = Math.floor(seconds / 60).toString().padStart(2, '0');
                let s = (seconds % 60).toString().padStart(2, '0');
                timerDiv.textContent = `${m}:${s}`;
            }, 1000);
        }

        window.toggleTheme = () => document.body.classList.toggle('light-mode');
        window.changeColor = () => {
            colorIndex = (colorIndex + 1) % colors.length;
            document.documentElement.style.setProperty('--accent', colors[colorIndex]);
        };

        function isValid(b, r, c, k) {
            for (let i = 0; i < 9; i++) {
                const m = 3 * Math.floor(r/3) + Math.floor(i/3), n = 3 * Math.floor(c/3) + i % 3;
                if (b[r][i] == k || b[i][c] == k || b[m][n] == k) return false;
            } return true;
        }

        function solve(b) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (b[r][c] === 0) {
                        for (let k = 1; k <= 9; k++) {
                            if (isValid(b, r, c, k)) { b[r][c] = k; if (solve(b)) return true; b[r][c] = 0; }
                        } return false;
                    }
                }
            } return true;
        }

        window.initGame = () => {
            history = []; overlay.style.display = 'none'; gridDiv.style.filter = 'none';
            startTimer();
            let board = Array.from({length: 9}, () => Array(9).fill(0));
            for (let i = 0; i < 9; i += 3) {
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 3; c++) {
                        let num; do { num = Math.floor(Math.random() * 9) + 1; } while (!isValid(board, i+r, i+c, num));
                        board[i+r][i+c] = num;
                    }
                }
            }
            solve(board);
            solution = board.map(row => [...row]);
            const diff = document.getElementById('difficulty').value;
            const puzzle = board.map(row => row.map(v => Math.random() * 81 < (81 - diff) ? v : 0));
            render(puzzle);
            updateNumpadStatus();
        };

        function highlight(cell) {
            const r = cell.dataset.r, c = cell.dataset.c, val = cell.textContent;
            document.querySelectorAll('.cell').forEach(el => {
                el.classList.remove('related', 'same-num', 'selected');
                if (el.dataset.r == r || el.dataset.c == c) el.classList.add('related');
                if (val && el.textContent === val && val !== "" && !val.includes('n')) el.classList.add('same-num');
            });
            cell.classList.add('selected');
        }

        function render(p) {
            gridDiv.textContent = '';
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r; cell.dataset.c = c;
                    if (p[r][c] !== 0) { cell.textContent = p[r][c]; cell.classList.add('fixed'); }
                    cell.onclick = () => { selectedCell = cell; highlight(cell); };
                    gridDiv.appendChild(cell);
                }
            }
        }

        window.handleInput = (num, isUndo = false) => {
            if (!selectedCell || selectedCell.classList.contains('fixed')) return;
            
            if (!isUndo) {
                history.push({
                    cellR: selectedCell.dataset.r,
                    cellC: selectedCell.dataset.c,
                    oldVal: selectedCell.dataset.val || '',
                    oldText: selectedCell.textContent,
                    oldSize: selectedCell.style.fontSize
                });
            }

            if (num === null) { 
                selectedCell.textContent = ''; 
                delete selectedCell.dataset.val; 
            } else if (isNotesMode) { 
                selectedCell.textContent = `n${num}`; 
                selectedCell.style.fontSize = "0.7rem"; 
            } else { 
                selectedCell.textContent = num; 
                selectedCell.dataset.val = num; 
                selectedCell.style.fontSize = "1.4rem"; 
            }
            
            highlight(selectedCell);
            updateNumpadStatus();
            checkAutoValidate();
        };

        window.undoMove = () => {
            if (history.length === 0) return;
            const lastMove = history.pop();
            const cell = document.querySelector(`.cell[data-r="${lastMove.cellR}"][data-c="${lastMove.cellC}"]`);
            selectedCell = cell;
            cell.textContent = lastMove.oldText;
            if (lastMove.oldVal) cell.dataset.val = lastMove.oldVal;
            else delete cell.dataset.val;
            cell.style.fontSize = lastMove.oldSize;
            highlight(cell);
            updateNumpadStatus();
        };

        function updateNumpadStatus() {
            const counts = {};
            document.querySelectorAll('.cell').forEach(c => {
                const val = parseInt(c.dataset.val || c.textContent);
                if (val && !c.textContent.includes('n')) {
                    if (val === solution[c.dataset.r][c.dataset.c]) {
                        counts[val] = (counts[val] || 0) + 1;
                    }
                }
            });
            for (let i = 1; i <= 9; i++) {
                const btn = document.getElementById(`num-${i}`);
                if (counts[i] === 9) btn.classList.add('done');
                else btn.classList.remove('done');
            }
        }

        function checkAutoValidate() {
            const cells = document.querySelectorAll('.cell');
            const filledCells = Array.from(cells).filter(c => c.textContent !== '' && !c.textContent.includes('n'));
            if (filledCells.length === 81) {
                let win = true;
                cells.forEach(c => {
                    const val = c.classList.contains('fixed') ? c.textContent : c.dataset.val;
                    if (parseInt(val) !== solution[c.dataset.r][c.dataset.c]) win = false;
                });
                if (win) showVictory();
                else alert("Almost! A few numbers aren't quite right yet.");
            }
        }

        function showVictory() {
            clearInterval(timerInterval);
            let starCount = seconds < 300 ? "⭐⭐⭐" : (seconds < 600 ? "⭐⭐" : "⭐");
            document.getElementById('star-container').textContent = starCount;
            document.getElementById('final-time').textContent = `Time: ${timerDiv.textContent}`;
            overlay.style.display = 'flex';
            gridDiv.style.filter = 'blur(8px)';
        }

        window.toggleNotes = () => {
            isNotesMode = !isNotesMode;
            document.getElementById('notes-btn').style.background = isNotesMode ? "#03dac6" : "var(--accent)";
        };

        window.onload = initGame;
    </script>
</body>
</html>
